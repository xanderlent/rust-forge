<!DOCTYPE html>
<!-- Page last generated 2019-03-06 13:48:16 +0000 -->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>rustc diagnostic codes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Rust, Rust programming language, rustlang, rust-lang, Mozilla Rust">
    <meta name="description" content="A systems programming language that runs blazingly fast, prevents segfaults, and guarantees thread safety.">
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/forge.css">
    <link rel="stylesheet" href="/rust-forge/css/bootstrap.css">
    <link rel="stylesheet" href="/rust-forge/css/style.css">
    <link rel="stylesheet" href="/rust-forge/css/forge.css">
  </head>

  <body class="container">

    <header>

    <ul class="row menu">
      <li class="col-xs-12 col-md-2">
        <a href="index.html">
	  <!-- FIXME: absolute urls -->
          <img class="img-responsive" src="https://www.rust-lang.org/logos/rust-logo-blk.svg" onerror="this.src='https://www.rust-lang.org/logos/rust-logo-256x256-blk.png'" height="128" width="128" alt="Rust logo" />
        </a>
      </li>
      <li class="col-xs-12 col-md-6 menu">
	<h1>Rust Forge</h1>
      </li>
    </ul>
    </header>

    <div class="content"><p>We generally try assign each error message a unique code like <code class="highlighter-rouge">E0123</code>.
These codes are defined in the compiler in the <code class="highlighter-rouge">diagnostics.rs</code> files
found in each crate, which basically consist of macros. The codes come
in two varieties: those that have an extended write-up, and those that
do not. Whenever possible, if you are making a new code, you should
write an extended write-up.</p>

<h3 id="allocating-a-fresh-code">Allocating a fresh code</h3>

<p>If you want to create a new error, you first need to find the next available
code. This is a bit tricky since the codes are defined in various crates.
To do it, run this obscure command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./x.py test --stage 0 src/tools/tidy
</code></pre></div></div>

<p>This will invoke the tidy script, which generally checks that your
code obeys our coding conventions. One of those jobs is to check that
diagnostic codes are indeed unique. Once it is finished with that,
tidy will print out the lowest unused code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
tidy check (x86_64-apple-darwin)
* 470 error codes
* highest error code: E0591
...
</code></pre></div></div>

<p>Here we see the highest error code in use is <code class="highlighter-rouge">E0591</code>, so we <em>probably</em>
want <code class="highlighter-rouge">E0592</code>. To be sure, run <code class="highlighter-rouge">rg E0592</code> and check, you should see no
references.</p>

<p>Next, open <code class="highlighter-rouge">src/{crate}/diagnostics.rs</code> within the crate where you wish
to issue the error (e.g., <code class="highlighter-rouge">src/librustc_typeck/diagnostics.rs</code>). Ideally,
you will add the code (in its proper numerical order) into the <code class="highlighter-rouge">register_long_diagnostics!</code> macro,
sort of like this:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">register_long_diagnostics!</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">E0592</span><span class="p">:</span> <span class="n">r</span>##<span class="s">"
Your extended error text goes here!
"</span>##<span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>But you can also add it without an extended description:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">register_diagnostics!</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">E0592</span><span class="p">,</span> <span class="c">// put a description here</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To actually issue the error, you can use the <code class="highlighter-rouge">struct_span_err!</code> macro:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">struct_span_err!</span><span class="p">(</span><span class="k">self</span><span class="py">.tcx.sess</span><span class="p">,</span> <span class="c">// some path to the session here</span>
                 <span class="n">span</span><span class="p">,</span> <span class="c">// whatever span in the source you want</span>
                 <span class="n">E0592</span><span class="p">,</span> <span class="c">// your new error code</span>
                 <span class="o">&amp;</span><span class="nd">format!</span><span class="p">(</span><span class="s">"text of the error"</span><span class="p">))</span>
    <span class="nf">.emit</span><span class="p">()</span> <span class="c">// actually issue the error</span>
</code></pre></div></div>

<p>If you want to add notes or other snippets, you can invoke methods
before you call <code class="highlighter-rouge">.emit()</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">struct_span_err!</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="nf">.span_label</span><span class="p">(</span><span class="n">another_span</span><span class="p">,</span> <span class="s">"something to label in the source"</span><span class="p">)</span>
    <span class="nf">.span_note</span><span class="p">(</span><span class="n">another_span</span><span class="p">,</span> <span class="s">"some separate note, probably avoid these"</span><span class="p">)</span>
    <span class="nf">.emit_</span><span class="p">()</span>
</code></pre></div></div>

</div>

  </body>
</html>
